# 🤖 退貨與保固洞察 AI 代理系統

## 🚀 線上展示 (Live Demo)

我已經將這個專案部署上線，您可以透過以下連結直接與它互動：  

👉 [**點此前往線上展示**](https://python-agent-app-chuan-jen.streamlit.app/)

---

## ✨ 設計理念與核心功能

在這個專案中，我設計了一個由 **兩個核心代理 (Agents)** 組成的系統，它們各自負責不同任務，並透過一個簡單的介面進行協調。  

---

### 1. 檢索代理 (Retrieval Agent) — 資料庫的心臟

最初的題目提示是使用自然語言來新增資料，但我認為一個 **結構化的表單** 能帶來更好的使用者體驗，並且能從源頭確保資料品質。  

#### 核心功能
- **自動化主鍵**  
  `Order ID` 由系統自動生成（抓取最新 ID +1），完全避免主鍵重複或無效的風險。  

- **雲端資料來源**  
  應用程式啟動時，會自動從 **Google Sheet** 讀取資料，而不是依賴固定的本地 CSV。  

- **前端驗證**  
  在送出前檢查輸入的格式，例如：產品名稱至少 2 個字元、店家名稱至少 2 個字元、金額必須大於 0。  

#### 🔧 新增的程式邏輯
在最新的版本中，對 **檢索代理** 新增了幾個功能：  

1. **雙重輸入模式**  
   - 支援 **表單輸入** 與 **自然語言輸入 (NLP)**。  
   - NLP 模式會呼叫 **Google Gemini API**，自動解析為結構化資料，並寫入資料庫。  

2. **NLP 資料落地策略**  
   - 缺漏欄位會補上預設值（數字 → `0.0`，文字 → `"Unknown"`）。  
   - NLP 新增紀錄一律標記為 **未批准 (`approved_flag = No`)**。  

3. **非同步請求 (async/await)**  
   - 使用 **httpx.AsyncClient** 搭配 `async/await`，避免阻塞 UI。  

4. **即時回饋機制**  
   - NLP 解析時顯示 spinner「AI 正在解析中…」，完成後直接展示 JSON 結果，讓使用者確認。  

---

### 2. 報告代理 (Report Agent) — 商業洞察的窗口

**報告代理** 的目標是提供快速的數據洞察。它會生成一份包含兩個工作表的 Excel 報告：  

- **`Summary` (摘要)**  
  提供高層次的 KPIs，例如總退貨成本、已批准的退貨比例。  

- **`Findings` (詳細資料)**  
  包含完整的資料庫內容，方便進行深度分析。  

---

### 🏗️ 系統架構圖

```mermaid
flowchart TD
    subgraph User["使用者"]
        A1["表單輸入"] --> C
        A2["自然語言輸入 (NLP)"] --> C
        A3["下載報告"] --> E
    end

    subgraph Coordinator["協調器 (Streamlit 前端)"]
        C["分派請求"]
    end

    subgraph RetrievalAgent["檢索代理 (Retrieval Agent)"]
        C --> B1["驗證 / NLP 解析"]
        B1 --> B2["SQLite 資料庫"]
        B2 --> B3["更新紀錄 / 回傳清單"]
    end

    subgraph ReportAgent["報告代理 (Report Agent)"]
        C --> D1["取得資料"]
        D1 --> D2["生成 Excel 報告"]
        D2 --> E["回傳下載連結"]
    end
